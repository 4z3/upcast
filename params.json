{"name":"Upcast","tagline":"operation declarative cloud ʕノ•ᴥ•ʔノ ︵ ┻━┻","body":"Upcast is a declarative cloud infrastructure orchestration tool that leverages [Nix](http://nixos.org/nix/).\r\nIts nix codebase (and, by extension, its interface) was started off by copying files from [nixops](https://github.com/nixos/nixops).\r\n\r\n[![Build Status](https://travis-ci.org/zalora/upcast.svg?branch=master)](https://travis-ci.org/zalora/upcast)\r\n\r\n### Quick start\r\n\r\n```console\r\nupcast - infrastructure orchestratrion\r\n\r\nUsage: upcast COMMAND\r\n\r\nAvailable commands:\r\n  run                      evaluate resources, run builds and deploy\r\n  build                    perform a build of all machine closures\r\n  ssh-config               dump ssh config for deployment (evaluates resources)\r\n  resource-info            dump resource information in json format\r\n  resource-debug           evaluate resources in debugging mode\r\n```\r\n\r\n\r\n```console\r\n$ awk 'NR==1{print \"default\", $1, $2}' ~/.ec2-keys > ~/.aws-keys # assuming you used nixops\r\n$ cabal install\r\n$ upcast run my-network.nix -- -j4\r\n```\r\n\r\nSee example deployments in `examples/`.\r\n\r\n### Goals\r\n\r\n- simplicity, extensibility;\r\n- shared state stored as nix expressions next to machines expressions;\r\n- first-class AWS support (including AWS features nixops doesn't have);\r\n- minimum dependency of network latency of the client (see section \"Network performance\");\r\n- support for running day-to-day operations on deployed resources, services and machines.\r\n\r\n### Notable differences from NixOps\r\n\r\n#### Expression files\r\n\r\n- You can no longer specify the machine environment using `deployment.targetEnv`, now you need to explicitly include the resource module instead.\r\n  Currently available modules are: `<upcast/env-ec2.nix>`.\r\n\r\n#### Operation modes\r\n\r\n- The only supported command is `run` (so far). No `create`, `modify`, `clone`, `set-args`, `send-keys`.\r\n- NixOps SQLite state files are abandoned, separate text files ([json dict for state](https://github.com/zalora/upcast/blob/master/src/Upcast/TermSubstitution.hs) and a private key file) are used instead;\r\n- Physical specs are removed\r\n  - Identical machines get identical machine closures, they are no longer parametric by things like hostnames (these are configured at runtime).\r\n\r\n#### Resources\r\n\r\n- New: EC2-VPC support, ELB support;\r\n- Additionally planned: AWS autoscaling, EBS snapshotting;\r\n- Different in EC2: CreateKeyPair (autogenerated private keys by amazon) is not supported, ImportKeyPair is used instead;\r\n- Not supported: sqs, s3, elastic ips, ssh tunnels, adhoc nixos deployments,\r\n                 deployments to expressions that span multiple AWS regions;\r\n- Most likely will not be supported: virtualbox, hetzner, auto-luks, auto-raid0, `/run/keys` support, static route53 support (like nixops);\r\n\r\n### Motivation\r\n\r\n![motivation](http://i.imgur.com/HY2Gtk5.png)\r\n\r\n### Network performance\r\n\r\n> tl;dr: do all of these steps if you're using a Mac and/or like visting Starbucks\r\n\r\n#### Configuring remote builds\r\n\r\nAdd the following to your shell profile (this is a must if you are using Darwin, otherwise package builds will fail):\r\n\r\n```bash\r\nexport NIX_BUILD_HOOK=\"$HOME/.nix-profile/libexec/nix/build-remote.pl\"\r\nexport NIX_REMOTE_SYSTEMS=\"$HOME/remote-systems.conf\"\r\nexport NIX_CURRENT_LOAD=\"/tmp/remote-load\"\r\n```\r\n\r\n`remote-systems.conf` must follow a special format described\r\nin [this Nix wiki page](https://nixos.org/wiki/Distributed_build)\r\nand [chapter 6 of Nix manual](http://nixos.org/nix/manual/#chap-distributed-builds).\r\n`NIX_CURRENT_LOAD` should point to a directory.\r\n\r\n#### Making instances download packages from a different host over ssh (a closure cache)\r\n\r\nThis is useful if one of your remote systems is accessible over ssh and has\r\nbetter latency to the instance than the machine you run Upcast on.\r\n\r\nThe key to that host must be already available in your ssh-agent.\r\nInherently, you also should propagate ssh keys of your instances to that ssh-agent in this case.\r\n\r\n```bash\r\nexport UPCAST_SSH_AUTH_SOCK=$SSH_AUTH_SOCK\r\nexport UPCAST_SSH_CLOSURE_CACHE=nix-ssh@example.com\r\n```\r\n\r\n#### SSH shared connections\r\n\r\n`ControlMaster` helps speed up subsequent ssh sessions by reusing a single TCP connection. See [ssh_config(5)](http://www.openbsd.org/cgi-bin/man.cgi/OpenBSD-current/man5/ssh_config.5?query=ssh_config).\r\n\r\n```console\r\n% cat ~/.ssh/config\r\nHost *\r\n    ControlPath ~/.ssh/master-%r@%h:%p\r\n    ControlMaster auto\r\n    ControlPersist yes\r\n```\r\n\r\n### Known issues\r\n\r\n- state files are not garbage collected, have to be often cleaned up manually;\r\n- altering of most resources is not supported properly (you need to remove using aws cli, cleanup the state file and try again);\r\n- word \"aterm\" is naming a completely different thing;\r\n\r\nNote: the app is currently in HEAVY development (and is already being used to power production cloud instances)\r\nso interfaces may break without notice.\r\n\r\n### More stuff\r\n\r\nThe AWS client code now lives in its own library: [zalora/aws-ec2](https://github.com/zalora/aws-ec2).\r\n","google":"UA-54327624-1","note":"Don't delete this file! It's used internally to help with page regeneration."}